<DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <meta http-equiv="X-UA-Compatible" content="IE=edge" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <link rel="stylesheet" href="styles.css" />
            <title>Cypress</title>
        </head>
        <body>
            <br /><br /><br /><br /><br /><br /><br /><br />
            <div class="content">
                <div class="flex-container">
                    <div class="flex-child">
                        <h1 style="text-align: left; margin-left: 3%">CYPRESS</h1>
                    </div>

                    <div class="flex-child">
                        <h2 style="text-align: right; margin-right: 10%">
                        City of Toronto
                        </h2>
                    </div>
                </div>

                <hr class="line" />
                <br />
                <div style="margin-left: 5%; margin-right: 5%">
                    <br />

                    <h1>Edit Report:</h1>
                    <hr style="border: 1px solid rgb(167, 163, 163)" />
                    <br />
                    <div class="flex-container">
                        <div class="flex-child" id="report">
                            <input type="text" value="" id="problem"></br></br>
                            <input type="text" value="" id="location">
                            <button><a href="portal.html">Back</a></button> <br /><br />
                        </div>

                        <div class="flex-child">
                            <input type="text" id="address">
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
                <br /><br />
                <a class="faq" href="faq.html">FAQ</a>
                <br /><br />
            </div>

            <script
                async
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLwHjzJ7zHoPkatUiUayePQ8NIDuYIHho&libraries=places&callback=initMap"
            ></script>

            <script>
                let parameters = new URLSearchParams(window.location.search);
                reportID = parameters.get("rid");
                
                document.addEventListener('DOMContentLoaded', () => {
                    fetch("https://api-cypress.herokuapp.com/api/report/info", {
                        method: "POST",
                        mode: "cors",
                        cache: "no-cache",
                        credentials: "same-origin",
                        headers: {
                        "Content-type": "application/json",
                        },
                        redirect: "follow",
                        referrerPolicy: "no-referrer",
                        body: JSON.stringify({
                            rid: reportID,
                        }),
                    }).then((res) => res.json())
                    .then((data) =>{
                        var report = data.report;
                        var err = data.error;

                        if (data.error) {
                            document.getElementById("response").innerHTML = err;
                        } else {
                            var problem = report.problem;
                            var address = report.address;
                            document.querySelector("#address").value = address;
                            document.getElementById("problem").value = problem;
                            document.getElementById("location").value = address;
                        }
                    });
                });

                function getaddress(lat, lng) {
                    return fetch(
                        `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=AIzaSyB6aG9lGJxMpYCAgrEnXgkkvqNkNFaDrjo`
                    )
                        .then((res) => res.json())
                        .then((data) => {
                        if (data.results) {
                            return data.results[0].formatted_address;
                        }
                        return "";
                        });
                }
                
                var marker;

                function initMap() {
                    const map = new google.maps.Map(document.getElementById("map"), {
                        center: { lat: 43.711351, lng: -79.376146 },
                        zoom: 11,
                        mapTypeId: "roadmap",
                        draggableCursor: "default",
                    });
                    const input = document.getElementById("address");

                    const searchBox = new google.maps.places.SearchBox(input);
                    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

                    map.addListener("bounds_changed", () => {
                        searchBox.setBounds(map.getBounds());
                    });

                    map.addListener("click", (e) => {
                        if (marker) {
                        marker.setMap(null);
                        }

                        marker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        });

                        map.panTo(e.latLng);

                        getaddress(e.latLng.lat(), e.latLng.lng()).then((address) => {
                        document.querySelector("#address").value = address;
                        });
                    });

                    searchBox.addListener("places_changed", () => {
                        const places = searchBox.getPlaces().slice(0, 1);

                        if (places.length == 0) {
                        return;
                        }

                        if (marker) {
                        marker.setMap(null);
                        }

                        const bounds = new google.maps.LatLngBounds();

                        places.forEach((place) => {
                        console.log(places.length);
                        if (!place.geometry || !place.geometry.location) {
                            console.log("Returned place contains no geometry");
                            return;
                        }

                        marker = new google.maps.Marker({
                            map,
                            position: place.geometry.location,
                        });

                        if (place.geometry.viewport) {
                            bounds.union(place.geometry.viewport);
                        } else {
                            bounds.extend(place.geometry.location);
                        }
                        });
                        map.fitBounds(bounds);
                    });
                }

            </script>
        </body>
    </html>
</DOCTYPE>